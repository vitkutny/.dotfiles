#!/usr/bin/env sh
# simplified version of https://github.com/jschlatow/taskopen

IFS=$'\n'
FZF_OPTS=(
	--layout=reverse
)

if [ -z "$FULLSCREEN" ]; then
	FULLSCREEN=0

	if [ "$(ps -p "$PPID" -o command | tail -n1)" = "taskwarrior-tui" ]; then
		FULLSCREEN=1
	fi
fi

if [ "$FULLSCREEN" -eq 1 ]; then
	FZF_OPTS+=(
		--style=full
		--border
		--border-label=" taskopen "
	)
else
	FZF_OPTS+=(
		--height="~100%"
	)
fi

if [ -z "$OPENER" ]; then
	if command -v open > /dev/null; then
		OPENER=open
	elif command -v xdg-open > /dev/null; then
		OPENER=xdg-open
	fi
fi

if [ -z "$VIEWER" ]; then
	if command -v view > /dev/null; then
		VIEWER="view --not-a-term -"
	elif command -v less > /dev/null; then
		VIEWER=less
	fi
fi

if [ -z "$COPIER" ]; then
	if command -v pbcopy > /dev/null; then
		COPIER=pbcopy
	elif command -v xclip > /dev/null; then
		COPIER=xclip
	fi
fi

tasks_description="$@"
tasks=($(task $@ export | jq --compact-output '.[]'))
tasks_annotations=($(echo "${tasks[*]}" | jq -r '.annotations.[]?.description'))
tasks_annotations_empty=0

if [ ${#tasks_annotations[@]} -eq 0 ]; then
	tasks_annotations_empty=1
	tasks_annotations+=("No annotation found for task")
fi

tasks_annotations_add='  ...add annotation'
tasks_annotations_delete='  ...delete annotation'

if [ ${#tasks[@]} -eq 1 ]; then
	tasks_description="$(echo $tasks | jq -r '.description')"
	tasks_annotations+=("$tasks_annotations_add")
fi

while true; do
	selected_annotation="$(echo "${tasks_annotations[*]}" | uniq | fzf ${FZF_OPTS[@]} --header="$(echo "Please select an annotation from task \033[4m$tasks_description\033[0m")")"
	selected_annotation_input="$selected_annotation"

	if [ "$selected_annotation" = "$tasks_annotations_add" ]; then
		new_annotation="$(echo | fzf ${FZF_OPTS[@]} --print-query --header="$(echo "$tasks_annotations_add for task \033[4m$tasks_description\033[0m")" | tail -1)"

		if [ -z "$new_annotation" ]; then
			continue
		fi

		for task in "${tasks[@]}"; do
			task_uuid="$(echo $task | jq -r '.uuid')"
			task_annotations=($(echo $task | jq -r '.annotations.[]?.description'))

			for task_annotation in "${task_annotations[@]}"; do
				if [ "$task_annotation" = "$new_annotation" ]; then
					continue 2
				fi
			done

			task "uuid:$task_uuid" annotate "$new_annotation" > /dev/null 2>&1
		done

		exec $0 $@
		exit 1
	elif [ -z "$selected_annotation" ] || [ "$tasks_annotations_empty" -eq 1 ]; then
		exit 0
	fi

	annotation_actions=()

	if [[ "$selected_annotation" == *"/"* ]]; then
		# replace leading ~ with $HOME
		selected_annotation_input="${selected_annotation_input/#\~/$HOME}"

		if ! [ -z "$OPENER" ]; then
			annotation_actions+=("$OPENER")
		fi

		if [ -f "$selected_annotation_input" ]; then
			if ! [ -z "$VISUAL" ]; then
				annotation_actions+=("$VISUAL")
			fi

			if ! [ -z "$EDITOR" ]; then
				annotation_actions+=("$EDITOR")
			fi
		fi
	fi

	if ! [ -z "$VIEWER" ]; then
		annotation_actions+=("$VIEWER")
	fi

	if ! [ -z "$COPIER" ]; then
		annotation_actions+=("$COPIER")
	fi

	annotation_actions+=("$tasks_annotations_delete")

	selected_action="$(echo "${annotation_actions[*]}" | uniq | fzf ${FZF_OPTS[@]} --header="$(echo "Please select an action for \033[4m$selected_annotation\033[0m")")"

	if [ -z "$selected_action" ]; then
		continue
	fi

	break
done

if [ "$selected_action" = "$tasks_annotations_delete" ]; then
	for task in "${tasks[@]}"; do
		task_uuid="$(echo $task | jq -r '.uuid')"
		task_annotations=($(echo $task | jq -r '.annotations.[]?.description'))

		for task_annotation in "${task_annotations[@]}"; do
			if [ "$task_annotation" = "$selected_annotation" ]; then
				task rc.context=off "uuid:$task_uuid" denotate "$selected_annotation" > /dev/null 2>&1
			fi
		done
	done

	exec $0 $@
	exit 1
fi

IFS=' '

if [ "$selected_action" = "$VIEWER" ] || [ "$selected_action" = "$COPIER" ]; then
	selected_annotation_input="$(mktemp)"
	printf "$selected_annotation" > $selected_annotation_input
	exec $selected_action < $selected_annotation_input
	exit 1
fi

exec $selected_action "$selected_annotation_input"
exit 1

