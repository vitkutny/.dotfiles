#!/usr/bin/env sh
# simplified version of https://github.com/jschlatow/taskopen

IFS=$'\n'
FZF_OPTS=(
	--style=full
	--layout=reverse
	--border
	--border-label=" taskopen "
)

task_annotations=($(task $@ export | jq -r '.[].annotations.[]?.description'))
task_annotations_empty=0

if [ ${#task_annotations[@]} -eq 0 ]; then
	task_annotations_empty=1
	task_annotations+=("No annotation found for task ${@}")
fi

annotation_actions=()

if ! [ -z "$OPENER" ]; then
	annotation_actions+=("$OPENER")
fi

if ! [ -z "$VISUAL" ]; then
	annotation_actions+=("$VISUAL")
fi

if ! [ -z "$EDITOR" ]; then
	annotation_actions+=("$EDITOR")
fi

if ! [ -z "$VIEWER" ]; then
	annotation_actions+=("$VIEWER")
fi

annotation_actions_empty=0

if [ ${#annotation_actions[@]} -eq 0 ]; then
	annotation_actions_empty=1
	annotation_actions+=("No annotation action defined")
fi

while true; do
	selected_annotation="$(echo "${task_annotations[*]}" | fzf ${FZF_OPTS[@]} --header="Please select an annotation")"

	if [ -z "$selected_annotation" ] || [ "$task_annotations_empty" -eq 1 ]; then
		exit 0
	fi

	selected_action=$(echo "${annotation_actions[*]}" | uniq | fzf ${FZF_OPTS[@]} --header="$(echo "Please select an action for \033[4m$selected_annotation\033[0m")")

	if [ -z "$selected_action" ] || [ "$annotation_actions_empty" -eq 1 ]; then
		continue
	fi

	break
done

# replace leading ~ with $HOME
selected_annotation="${selected_annotation/#\~/$HOME}"

IFS=' '
exec $selected_action "$selected_annotation"

