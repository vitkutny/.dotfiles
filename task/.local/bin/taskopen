#!/usr/bin/env sh
# simplified version of https://github.com/jschlatow/taskopen

IFS=$'\n'
FZF_OPTS=(
	--layout=reverse
)

if [ -z "$FULLSCREEN" ]; then
	FULLSCREEN=0

	if [ "$(ps -p "$PPID" -o command | tail -n1)" = "taskwarrior-tui" ]; then
		FULLSCREEN=1
	fi
fi

if [ "$FULLSCREEN" -eq 1 ]; then
	FZF_OPTS+=(
		--style=full
		--border
		--border-label=" taskopen "
	)
else
	FZF_OPTS+=(
		--height="~100%"
	)
fi

if [ -z "$OPENER" ]; then
	if command -v open > /dev/null; then
		OPENER=open
	elif command -v xdg-open > /dev/null; then
		OPENER=xdg-open
	fi
fi

if [ -z "$VIEWER" ]; then
	if command -v view > /dev/null; then
		VIEWER="view --not-a-term -"
	elif command -v less > /dev/null; then
		VIEWER=less
	fi
fi

if [ -z "$COPIER" ]; then
	if command -v pbcopy > /dev/null; then
		COPIER=pbcopy
	elif command -v xclip > /dev/null; then
		COPIER=xclip
	fi
fi

tasks_description="$@"
tasks=($(task $@ export | jq --compact-output '.[]' | sed 's/\\n/\\\\n/g'))
tasks_annotations=($(echo "${tasks[*]}" | sed 's/\\n/\\\\n/g' | jq -r '.annotations.[]?.description' | sort -u))
tasks_annotations_empty="  ...no annotation found for task"

if [ ${#tasks_annotations[@]} -eq 0 ]; then
	tasks_annotations+=("$tasks_annotations_empty")
fi

tasks_annotations_add='  ...add annotation'
tasks_annotations_edit='  ...edit annotation'
tasks_annotations_delete='  ...delete annotation'

if [ ${#tasks[@]} -eq 1 ]; then
	tasks_description="$(echo $tasks | jq -r '.description')"

	if ! [ -z "$VISUAL" ] || ! [ -z "$EDITOR" ]; then
		tasks_annotations+=("$tasks_annotations_add")
	fi
fi

while true; do
	#TODO: fzf preview window of whole content – max height of row to show only matching part ?
	if [ -z "$selected_annotation" ]; then
		selected_annotation="$(echo "${tasks_annotations[*]//\\n/\\\\n}" | tr '\n' '\0' | sed 's/\\n/\n/g' | fzf --read0 ${FZF_OPTS[@]} --header="$(echo "Please select an annotation from task \033[4m$tasks_description\033[0m")")"
	fi

	if [ -z "$selected_annotation" ] || [ "$selected_annotation" = "$tasks_annotations_empty" ]; then
		exit 0
	elif [ "$selected_annotation" = "$tasks_annotations_add" ]; then
		selected_annotation_input=""
	elif [ "$selected_annotation" != "$tasks_annotations_edit" ]; then
		selected_annotation_input="${selected_annotation}"
	fi

	annotation_actions=()

	if [ "$selected_annotation" = "$tasks_annotations_add" ] || [ "$selected_annotation" = "$tasks_annotations_edit" ]; then
		if ! [ -z "$VISUAL" ]; then
			annotation_actions+=("$VISUAL")
		fi

		if ! [ -z "$EDITOR" ]; then
			annotation_actions+=("$EDITOR")
		fi
	else
		if [[ "$selected_annotation_input" == *"/"* ]]; then
			# replace leading ~ with $HOME
			selected_annotation_input="${selected_annotation_input/#\~/$HOME}"

			if ! [ -z "$OPENER" ]; then
				annotation_actions+=("$OPENER")
			fi

			if [ -f "$selected_annotation_input" ]; then
				if ! [ -z "$VISUAL" ]; then
					annotation_actions+=("$VISUAL")
				fi

				if ! [ -z "$EDITOR" ]; then
					annotation_actions+=("$EDITOR")
				fi
			fi
		fi

		if ! [ -z "$VIEWER" ]; then
			annotation_actions+=("$VIEWER")
		fi

		if ! [ -z "$COPIER" ]; then
			annotation_actions+=("$COPIER")
		fi

		if ! [ -z "$VISUAL" ] || ! [ -z "$EDITOR" ]; then
			annotation_actions+=("$tasks_annotations_edit")
		fi

		annotation_actions+=("$tasks_annotations_delete")
	fi

	# TODO: fzf preview instead of selected_annotation in title?
	selected_action="$(echo "${annotation_actions[*]}" | uniq | fzf ${FZF_OPTS[@]} --header="$(echo "Please select an action for \033[4m${selected_annotation//\\n/\\\\n}\033[0m")")"

	if [ -z "$selected_action" ]; then
		if [ "$selected_annotation" = "$tasks_annotations_edit" ]; then
			selected_annotation="$selected_annotation_input"
		else
			selected_annotation=""
		fi
		continue
	elif [ "$selected_action" = "$tasks_annotations_edit" ]; then
		selected_annotation="$selected_action"
		continue
	elif [ "$selected_annotation" = "$tasks_annotations_add" ] || [ "$selected_annotation" = "$tasks_annotations_edit" ]; then
		selected_annotation_file="$(mktemp)"

		if ! [ -z "$selected_annotation_input" ]; then
			echo "$selected_annotation_input" >> $selected_annotation_file
		fi

		$selected_action "$selected_annotation_file"
		new_annotation="$(cat "$selected_annotation_file")"

		if [ -z "$new_annotation" ] || [ "$new_annotation" = "${selected_annotation_input}" ]; then
			continue
		fi

		# TODO: use JSON import instead of annotate/denotate to properly handle multiline annotations
		# - task denotate does not accept newline – should be reported as bug in taskwarrior (`task 1 annotate "foo\nbar"` cannot be deleted by `task 1 denotate "foo\nbar"`)
		# - using JSON will be better as it can be done in bulk for all modified $tasks and could preserve existing annotation time when annotation is edited (but dont know if keeping same old entry time is good, but it will be possible)
		for task in "${tasks[@]}"; do
			task_uuid="$(echo $task | jq -r '.uuid')"
			task_annotations=($(echo $task | sed 's/\\n/\\\\n/g' | jq -r '.annotations.[]?.description'))

			for task_annotation in "${task_annotations[@]}"; do
				if [ "$task_annotation" = "$new_annotation" ]; then
					continue 2
				fi
			done

			task "uuid:$task_uuid" annotate "$new_annotation" > /dev/null 2>&1
		done

		if [ "$selected_annotation" = "$tasks_annotations_add" ]; then
			exec $0 $@
			exit 1
		fi

		selected_action="$tasks_annotations_delete"
		selected_annotation="$selected_annotation_input"
	fi

	break
done

if [ "$selected_action" = "$tasks_annotations_delete" ]; then
	for task in "${tasks[@]}"; do
		task_uuid="$(echo $task | jq -r '.uuid')"
		task_annotations=($(echo $task | jq -r '.annotations.[]?.description'))

		for task_annotation in "${task_annotations[@]}"; do
			if [ "$task_annotation" = "$selected_annotation" ]; then
				task rc.context=off "uuid:$task_uuid" denotate "$selected_annotation" > /dev/null 2>&1
			fi
		done
	done

	exec $0 $@
	exit 1
fi

IFS=' '

if [ "$selected_action" = "$VIEWER" ] || [ "$selected_action" = "$COPIER" ]; then
	selected_annotation_file="$(mktemp)"
	printf "$selected_annotation" > $selected_annotation_file
	exec $selected_action < $selected_annotation_file
	exit 1
fi

exec $selected_action "$selected_annotation_input"
exit 1

