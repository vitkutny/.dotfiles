#!/usr/bin/env bash

NEWLINE=$'\n'
IFS=$NEWLINE
FZF_OPTS=(
	--layout=reverse
	--style=full
	--color=base16
	--border
	--border-label="[ taskopen ]"
)
# Preview window sizing - specify size of finder list instead of preview window [https://github.com/junegunn/fzf/issues/3570]
FZF_PREVIEW_TRANSFORMER_TOTAL_COUNT='
	lines=$(( FZF_LINES - FZF_TOTAL_COUNT - 10 ))
	if [ $lines -gt 0 ]; then
		echo "change-preview-window:$lines"
	else
		echo "change-preview-window:hidden"
	fi
'

if [ -z "$OPENER" ]; then
	if command -v open > /dev/null; then
		OPENER=open
	elif command -v xdg-open > /dev/null; then
		OPENER=xdg-open
	fi
fi

if [ -z "$PREVIEWER" ]; then
	if command -v bat > /dev/null; then
		PREVIEWER="bat --paging=never --theme=ansi --color=always --style=plain"
	else
		PREVIEWER=cat
	fi
fi

if [ -z "$VIEWER" ]; then
	if command -v view > /dev/null; then
		VIEWER=view
	elif command -v less > /dev/null; then
		VIEWER=less
	fi
fi

if [ -z "$COPIER" ]; then
	if command -v pbcopy > /dev/null; then
		COPIER=pbcopy
	elif command -v xclip > /dev/null; then
		COPIER=xclip
	fi
fi

if [ -z "$VISUAL" ]; then
	if command -v nvim > /dev/null; then
		VISUAL=nvim
	elif command -v vim > /dev/null; then
		VISUAL=vim
	elif command -v vi > /dev/null; then
		VISUAL=vi
	fi
fi

EDITORS=()

if ! [ -z "$VISUAL" ]; then
	EDITORS+=("$VISUAL")
fi

if ! [ -z "$EDITOR" ]; then
	EDITORS+=("$EDITOR")
fi

MIME_TYPES=

if [ -r "/etc/mime.types" ]; then
	MIME_TYPES="/etc/mime.types"
elif [ -r "/etc/apache2/mime.types" ]; then
	MIME_TYPES="/etc/apache2/mime.types"
elif [ -r "/private/etc/apache2/mime.types" ]; then
	MIME_TYPES="/etc/mime.types"
fi

mime_type_ext () {
	if [ -z "$MIME_TYPES" ] || [ "$#" != 1 ]; then
		return
	fi

	grep "^$1"$'\t' $MIME_TYPES | awk -F '\t+' '{print $2}' | cut -d ' ' -f 1
}
mktemp_ext () {
	mktemp_file="$(mktemp)"

	if [ "$#" = 1 ]; then
		mv "$mktemp_file" "$mktemp_file.$1"
		mktemp_file="$mktemp_file.$1"
	fi

	echo "$mktemp_file"
}

tasks_filter="$@"

if [ -z "$tasks_filter" ]; then
	tasks_filter="status:pending"
elif [ "$tasks_filter" = "all" ]; then
	tasks_filter=""
fi

tasks_empty="  ...no tasks found"
tasks_annotations_empty="  ...no annotation found for task"
tasks_annotations_add='  ...add annotation'
tasks_annotations_edit='  ...edit annotation'
tasks_annotations_delete='  ...delete annotation'

tasks=()
load_tasks() {
	tasks=($(task $tasks_filter export | jq --compact-output '.[]'))
}

load_tasks

tasks_annotations=()
load_tasks_annotations() {
	tasks_annotations=($(printf '%s' "${tasks[*]}" | jq '.annotations.[]?.description' | sort -u))

	if [ ${#tasks[@]} -eq 0 ]; then
		tasks_annotations+=("\"$tasks_empty\"")
	elif [ ${#tasks_annotations[@]} -eq 0 ]; then
		tasks_annotations+=("\"$tasks_annotations_empty\"")
	fi

	if [ ${#tasks[@]} -gt 0 ] && [ ${#EDITORS} -gt 0 ]; then
		tasks_annotations+=("\"$tasks_annotations_add\"")
	fi
}

load_tasks_annotations

while true; do
	if [ -z "$selected_annotation" ]; then
		selected_annotation="$(printf '%s' "${tasks_annotations[*]}" | jq --raw-output0 | fzf ${FZF_OPTS[@]} \
			--header="Please select an annotation from task: $tasks_filter" \
			--read0 \
			--no-multi-line \
		)"
		selected_annotation_file=""

		if [ -z "$selected_annotation" ] || [ "$selected_annotation" = "$tasks_empty" ] || [ "$selected_annotation" = "$tasks_annotations_empty" ]; then
			exit 0
		elif [ "$selected_annotation" = "$tasks_annotations_add" ]; then
			selected_annotation=""
			selected_action="$tasks_annotations_add"
		else
			selected_action=""
		fi
	fi

	if [ -z "$selected_annotation_file" ]; then
		selected_annotation_file_ext="$(mime_type_ext "$(printf '%s' "$selected_annotation" | file -b --mime-type -)")"

		if [ -z "$selected_annotation_file_ext" ] || [ "$selected_annotation_file_ext" = "txt" ]; then
			selected_annotation_file_ext="md"
		fi

		selected_annotation_file="$(mktemp_ext "$selected_annotation_file_ext")"
		printf '%s' "$selected_annotation" > $selected_annotation_file
		selected_annotation_preview_file="$selected_annotation_file"
		selected_annotation_preview_label="[ annotation.$selected_annotation_file_ext ]"
	fi

	if [ -z "$selected_action" ]; then
		annotation_actions=()

		if [[ "$selected_annotation" == *"/"* ]]; then
			if ! [ -z "$OPENER" ] && [[ "$selected_annotation" != *"$NEWLINE"* ]]; then
				annotation_actions+=("$OPENER")
			fi

			if [ -w "${selected_annotation/#\~/$HOME}" ]; then
				annotation_actions+=("${EDITORS[@]}")
			fi
		fi

		if ! [ -z "$VIEWER" ]; then
			annotation_actions+=("$VIEWER")
		fi

		if ! [ -z "$COPIER" ]; then
			annotation_actions+=("$COPIER")
		fi

		if [ ${#EDITORS} -gt 0 ]; then
			annotation_actions+=("$tasks_annotations_edit")
		fi

		annotation_actions+=("$tasks_annotations_delete")
		selected_action="$(echo "${annotation_actions[*]}" | uniq | fzf ${FZF_OPTS[@]} \
			--header="Please select an action for selected annotation from task: $tasks_filter" \
			--preview-window="down" \
			--preview-label="$selected_annotation_preview_label" \
			--preview="$PREVIEWER '$selected_annotation_preview_file'" \
			--bind="result:transform:$FZF_PREVIEW_TRANSFORMER_TOTAL_COUNT" \
			--bind="resize:transform:$FZF_PREVIEW_TRANSFORMER_TOTAL_COUNT" \
		)"

		if [ -z "$selected_action" ]; then
			selected_annotation=""
			continue
		fi
	fi

	if [ "$selected_action" = "$tasks_annotations_add" ] || [ "$selected_action" = "$tasks_annotations_edit" ]; then
		selected_editor="$(printf '%s' "${EDITORS[*]}" | uniq | fzf ${FZF_OPTS[@]} \
			--header="Please select an editor for $selected_action:" \
			--preview-window="down" \
			--preview-label="$selected_annotation_preview_label" \
			--preview="$PREVIEWER '$selected_annotation_preview_file'" \
			--bind="result:transform:$FZF_PREVIEW_TRANSFORMER_TOTAL_COUNT" \
			--bind="resize:transform:$FZF_PREVIEW_TRANSFORMER_TOTAL_COUNT" \
			--bind one:accept \
		)"

		if [ -z "$selected_editor" ]; then
			selected_action=""
			continue
		fi

		unset IFS
		$selected_editor "$selected_annotation_file"
		IFS=$NEWLINE
		new_annotation="$(cat "$selected_annotation_file")"

		if [ "$new_annotation" = "$selected_annotation" ]; then
			selected_action=""
			continue
		elif [ -z "$new_annotation" ]; then
			selected_action="$tasks_annotations_delete"
			continue
		fi

		# reload before import
		load_tasks
		modified_tasks=()

		for task in "${tasks[@]}"; do
			task_annotations=($(printf '%s' "$task" | jq --compact-output '.annotations.[]?'))

			if [ "$selected_action" = "$tasks_annotations_add" ]; then
				for task_annotation in "${task_annotations[@]}"; do
					task_annotation_description=$(printf '%s' "$task_annotation" | jq -r '.description')

					if [ "$task_annotation_description" = "$new_annotation" ]; then
						continue 2
					fi
				done

				modified_tasks+=("$(printf '%s' "$task" | jq --compact-output --arg entry "$(date +"%Y%m%dT%H%M%SZ")" --arg description "$new_annotation" '.annotations += [{"entry":$entry,"description":$description}]')")
			elif [ "$selected_action" = "$tasks_annotations_edit" ]; then
				modified_task="$task"
				for task_annotation in "${task_annotations[@]}"; do
					task_annotation_entry=$(printf '%s' "$task_annotation" | jq -r '.entry')
					task_annotation_description=$(printf '%s' "$task_annotation" | jq -r '.description')

					if [ "$task_annotation_description" != "$selected_annotation" ]; then
						continue
					fi

					modified_task="$(printf '%s' "$modified_task" | jq --compact-output --arg entry "$task_annotation_entry" --arg description "$new_annotation" '( .annotations[] | select(.entry == $entry) ).description = $description')"
				done

				if [ "$modified_task" != "$task" ]; then
					modified_tasks+=("$modified_task")
				fi
			fi
		done

		if [ ${#modified_tasks[@]} -gt 0 ]; then
			printf '%s' "${modified_tasks[*]}" | task import > /dev/null 2>&1
			modified_tasks=()
			# reload after import
			load_tasks
			selected_annotation="$new_annotation"
			selected_annotation_file=
		else
			selected_annotation=""
		fi

		load_tasks_annotations
		selected_action=""
		continue
	elif [ "$selected_action" = "$tasks_annotations_delete" ]; then
		# reload before import
		load_tasks
		modified_tasks=()

		for task in "${tasks[@]}"; do
			modified_task="$task"
			task_annotations=($(printf '%s' "$task" | jq --compact-output '.annotations.[]?'))
			for task_annotation in "${task_annotations[@]}"; do
				task_annotation_entry=$(printf '%s' "$task_annotation" | jq -r '.entry')
				task_annotation_description=$(printf '%s' "$task_annotation" | jq -r '.description')

				if [ "$task_annotation_description" != "$selected_annotation" ]; then
					continue
				fi

				modified_task="$(printf '%s' "$modified_task" | jq --compact-output --arg entry "$task_annotation_entry" 'del(.annotations[] | select(.entry == $entry))')"
			done

			if [ "$modified_task" != "$task" ]; then
				modified_tasks+=("$modified_task")
			fi
		done

		if [ ${#modified_tasks[@]} -gt 0 ]; then
			printf '%s' "${modified_tasks[*]}" | task import > /dev/null 2>&1
			modified_tasks=()
			# reload after import
			load_tasks
		fi

		load_tasks_annotations
		selected_annotation=""
		selected_action=""
		continue
	elif [ "$selected_action" = "$VIEWER" ]; then
		unset IFS
		if [ -r "${selected_annotation/#\~/$HOME}" ]; then
			$selected_action "${selected_annotation/#\~/$HOME}"
		else
			$selected_action $selected_annotation_file
		fi
		IFS=$NEWLINE
		selected_action=""
		continue
	elif [ "$selected_action" = "$COPIER" ]; then
		unset IFS
		$selected_action < "$selected_annotation_file"
		IFS=$NEWLINE
		selected_action=""
		continue
	fi

	unset IFS
	if [ -r "${selected_annotation/#\~/$HOME}" ]; then
		$selected_action "${selected_annotation/#\~/$HOME}"
	else
		$selected_action "$selected_annotation"
	fi
	IFS=$NEWLINE
	selected_action=""
done

